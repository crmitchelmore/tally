# Android Play Store Deployment
#
# Triggers:
# - Manual dispatch (workflow_dispatch) for on-demand releases
# - Push to main with version tag (v*) for automated releases
#
# Tracks:
# - internal: Every push to main (automatic)
# - alpha/beta/production: Promoted via workflow_dispatch
#
# Required secrets:
# - ANDROID_KEYSTORE_BASE64: Base64-encoded release keystore
# - ANDROID_KEYSTORE_PASSWORD: Keystore password
# - ANDROID_KEY_ALIAS: Key alias (default: tally)
# - ANDROID_KEY_PASSWORD: Key password
# - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: Service account JSON for Play Store API

name: Android (deploy)

on:
  workflow_dispatch:
    inputs:
      track:
        description: 'Play Store track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      promote_from:
        description: 'Promote from track (leave empty for new build)'
        required: false
        type: choice
        options:
          - ''
          - internal
          - alpha
          - beta
  push:
    branches: [main]
    paths:
      - 'tally-android/**'
    tags:
      - 'v*'

env:
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.track == 'production' && 'production' || 'development' }}
    defaults:
      run:
        working-directory: tally-android

    steps:
      - uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: tally-android

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore/release.keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create keystore directory
        run: mkdir -p keystore

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore/release.keystore

      - name: Create service account file
        run: echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > fastlane/play-store-service-account.json

      - name: Determine deployment action
        id: action
        run: |
          if [ "${{ github.event.inputs.promote_from }}" != "" ]; then
            echo "action=promote" >> $GITHUB_OUTPUT
            echo "from_track=${{ github.event.inputs.promote_from }}" >> $GITHUB_OUTPUT
            echo "to_track=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "action=deploy" >> $GITHUB_OUTPUT
            echo "track=internal" >> $GITHUB_OUTPUT
          else
            echo "action=deploy" >> $GITHUB_OUTPUT
            echo "track=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Play Store
        if: steps.action.outputs.action == 'deploy'
        run: bundle exec fastlane ${{ steps.action.outputs.track }}
        env:
          KEYSTORE_FILE: keystore/release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS || 'tally' }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          GOOGLE_PLAY_JSON_KEY_FILE: fastlane/play-store-service-account.json
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_ANDROID }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          LAUNCHDARKLY_MOBILE_KEY: ${{ secrets.LAUNCHDARKLY_MOBILE_KEY }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}

      - name: Promote release
        if: steps.action.outputs.action == 'promote'
        run: |
          bundle exec fastlane upload_to_play_store \
            track:${{ steps.action.outputs.from_track }} \
            track_promote_to:${{ steps.action.outputs.to_track }}
        env:
          GOOGLE_PLAY_JSON_KEY_FILE: fastlane/play-store-service-account.json

      - name: Clean up secrets
        if: always()
        run: |
          rm -f keystore/release.keystore
          rm -f fastlane/play-store-service-account.json

      - name: Upload APK artifact
        if: steps.action.outputs.action == 'deploy'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: tally-android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
