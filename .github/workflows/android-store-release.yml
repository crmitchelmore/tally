name: Android (store release)

on:
  workflow_dispatch:
    inputs:
      lane:
        description: "fastlane lane (internal|production)"
        required: true
        default: "internal"
        type: choice
        options:
          - internal
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: mobile-release
    defaults:
      run:
        working-directory: tally-android
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: Install gems
        run: bundle install

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p .ci
          printf '%s' "$ANDROID_KEYSTORE_BASE64" | base64 --decode > .ci/release.keystore
          chmod 600 .ci/release.keystore

      - name: Deploy
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/tally-android/.ci/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
        run: bundle exec fastlane android ${{ inputs.lane }}
