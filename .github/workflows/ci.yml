name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  statuses: write

jobs:
  # ─────────────────────────────────────────────────────────────
  # Web: lint + build
  # ─────────────────────────────────────────────────────────────
  web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install
      - name: Lint
        run: bun run lint
      - name: Build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          HONEYCOMB_API_KEY: ${{ secrets.HONEYCOMB_API_KEY }}
        run: bun run build

  # ─────────────────────────────────────────────────────────────
  # iOS: generate + build (macOS runner)
  # ─────────────────────────────────────────────────────────────
  ios:
    runs-on: macos-14
    defaults:
      run:
        working-directory: ios
    steps:
      - uses: actions/checkout@v4
      - name: Install Tuist via mise
        uses: jdx/mise-action@v2
        with:
          install_args: tuist@4.32.0
      - name: Generate Xcode project
        run: |
          mise use -g tuist@4.32.0
          tuist install
          tuist generate --no-open
      - name: Build iOS app
        run: |
          set -o pipefail
          if command -v xcpretty >/dev/null 2>&1; then
            xcodebuild \
              -workspace Tally.xcworkspace \
              -scheme App \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 16' \
              build \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              | xcpretty
          else
            xcodebuild \
              -workspace Tally.xcworkspace \
              -scheme App \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 16' \
              build \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO
          fi

  # ─────────────────────────────────────────────────────────────
  # Android: lint + build (ubuntu runner)
  # ─────────────────────────────────────────────────────────────
  android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tally-android
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build Android app
        run: ./gradlew assembleDebug --no-daemon
      - name: Run Android unit tests
        run: ./gradlew testDebugUnitTest --no-daemon

  # Required branch-protection status context (configured as "build")
  build:
    name: build
    runs-on: ubuntu-latest
    needs: [web, ios, android]
    if: always()
    steps:
      - name: Set commit status "build"
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha ?? context.sha;
            const results = [
              '${{ needs.web.result }}',
              '${{ needs.ios.result }}',
              '${{ needs.android.result }}',
            ];
            const ok = results.every(r => r === 'success');
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state: ok ? 'success' : 'failure',
              context: 'build',
              description: ok ? 'All CI jobs passed' : `CI failed: ${results.join(', ')}`,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
            core.info(`Set build status on ${sha}: ${ok ? 'success' : 'failure'}`);

