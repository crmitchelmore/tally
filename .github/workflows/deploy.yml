# Continuous Integration & Deployment Pipeline
#
# Flow:
# 1. CI checks (lint, build, unit tests) - always runs
# 2. Deploy to dev (infra + convex + vercel) - on main push
# 3. E2E tests on dev.tally-tracker.app - on main push
# 4. Deploy to prod (only if E2E passes) - on main push
#
# Uses GitHub environments for secret isolation:
# - development: dev Clerk, dev Convex, Pulumi dev stack
# - production: prod Clerk, prod Convex, Pulumi prod stack

name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [main]

env:
  NX_DAEMON: false

jobs:
  # ===========================================================================
  # Repo Hygiene - Lockfile Guards
  # ===========================================================================
  
  lockfile-guards:
    name: Lockfile Guards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for wrong lockfiles
        run: |
          ERRORS=0
          
          # tally-web should NOT have package-lock.json (uses bun)
          if [ -f "tally-web/package-lock.json" ]; then
            echo "::error::tally-web/package-lock.json should not exist (use bun)"
            ERRORS=$((ERRORS + 1))
          fi
          
          # infra should NOT have bun.lockb (uses npm)
          if [ -f "infra/bun.lockb" ]; then
            echo "::error::infra/bun.lockb should not exist (use npm)"
            ERRORS=$((ERRORS + 1))
          fi
          
          # packages should NOT have lockfiles (workspace packages)
          for dir in packages/*/; do
            if [ -f "${dir}package-lock.json" ] || [ -f "${dir}bun.lockb" ]; then
              echo "::error::${dir} should not have its own lockfile (workspace package)"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Lockfile policy:"
            echo "  - tally-web/: bun only (bun.lockb)"
            echo "  - infra/: npm only (package-lock.json)"
            echo "  - packages/*/: no lockfiles (workspace packages)"
            exit 1
          fi
          
          echo "✓ All lockfiles in correct locations"

  # ===========================================================================
  # CI Checks - Always Run
  # ===========================================================================
  
  lint-build-test:
    name: CI (lint/build/test)
    runs-on: ubuntu-latest
    needs: [lockfile-guards]
    environment: development
    outputs:
      commit_sha: ${{ github.sha }}
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          CLERK_PK_DEV: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV }}
          CLERK_SK_DEV: ${{ secrets.CLERK_SECRET_KEY_DEV }}
        run: |
          missing=""
          [ -z "$CLERK_PK_DEV" ] && missing="$missing NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV"
          [ -z "$CLERK_SK_DEV" ] && missing="$missing CLERK_SECRET_KEY_DEV"
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "✓ All required secrets present"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV }}
          CLERK_SECRET_KEY_DEV: ${{ secrets.CLERK_SECRET_KEY_DEV }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: tally-lz
          SENTRY_PROJECT: javascript-nextjs

      - name: Unit tests
        run: bun run test

      - name: API smoke
        run: bun run api:smoke
        env:
          TALLY_API_BASE: https://bright-jackal-396.convex.site

  # ===========================================================================
  # E2E Tests on PRs (run against local dev server)
  # ===========================================================================
  
  e2e-pr:
    name: E2E Tests (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint-build-test]
    environment: development
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        run: bun run test:e2e
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CONVEX_URL: https://bright-jackal-396.convex.cloud

      # Note: E2E auth tests run against deployed dev environment (post-merge to main)
      # They require real Clerk/Convex backends and can't run reliably against local dev server

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr
          path: tally-web/playwright-report/

  infra-typecheck:
    name: Infra (typecheck)
    runs-on: ubuntu-latest
    needs: [lockfile-guards]
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - name: Install deps
        run: npm ci --workspaces=false --include=dev

      - name: Typecheck
        run: npx --yes --package typescript tsc -p tsconfig.json --noEmit

  # ===========================================================================
  # Pulumi Preview (PRs only)
  # ===========================================================================
  
  infra-preview:
    name: Infra Preview (dev + prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [infra-typecheck]
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - name: Install deps
        run: npm ci --workspaces=false --include=dev

      - name: Install Pulumi CLI
        run: curl -fsSL https://get.pulumi.com | sh

      - name: Preview dev stack
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          export PATH="$HOME/.pulumi/bin:$PATH"
          pulumi preview --stack tally-tracker-org/dev

      - name: Preview prod stack
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          export PATH="$HOME/.pulumi/bin:$PATH"
          pulumi preview --stack tally-tracker-org/prod

  # ===========================================================================
  # Deploy to Development (main push only)
  # ===========================================================================
  
  deploy-dev-infra:
    name: Deploy Infra (dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint-build-test, infra-typecheck]
    environment: development
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          PULUMI_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          if [ -z "$PULUMI_TOKEN" ]; then
            echo "::error::Missing required secret: PULUMI_ACCESS_TOKEN"
            exit 1
          fi
          echo "✓ PULUMI_ACCESS_TOKEN present"

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - name: Install deps
        run: npm ci --workspaces=false --include=dev

      - name: Install Pulumi CLI
        run: curl -fsSL https://get.pulumi.com | sh

      - name: Pulumi up (dev)
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          export PATH="$HOME/.pulumi/bin:$PATH"
          pulumi up --yes --stack tally-tracker-org/dev

  deploy-dev-convex:
    name: Deploy Convex (dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint-build-test]
    environment: development
    outputs:
      convex_version: ${{ github.sha }}
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Check Convex deploy key
        id: convex_key
        env:
          CONVEX_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_DEV }}
        run: |
          if [ -z "$CONVEX_KEY" ]; then
            echo "::error::Missing required secret: CONVEX_DEPLOY_KEY_DEV"
            exit 1
          fi
          echo "✓ CONVEX_DEPLOY_KEY_DEV present"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Deploy Convex (dev)
        if: steps.convex_key.outputs.skip != 'true'
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_DEV }}
        run: bunx convex deploy --cmd-url-env-var-name CONVEX_DEPLOY_KEY

  deploy-dev-vercel:
    name: Deploy Vercel (dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [deploy-dev-infra, deploy-dev-convex]
    environment: development
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
      web_version: ${{ github.sha }}
    # Run from repo root; Vercel project Root Directory is already set to "tally-web"
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          missing=""
          [ -z "$VERCEL_TOKEN" ] && missing="$missing VERCEL_TOKEN"
          [ -z "$VERCEL_PROJECT_ID" ] && missing="$missing VERCEL_PROJECT_ID"
          [ -z "$VERCEL_ORG_ID" ] && missing="$missing VERCEL_ORG_ID"
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "✓ All Vercel secrets present"

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write Vercel project.json
        run: |
          mkdir -p .vercel
          cat > .vercel/project.json <<JSON
          {"projectId":"prj_tXdIJDmRB1qKZyo5Ngat62XoaMgw","orgId":"team_ifle7fkp7usKufCL8MUCY1As"}
          JSON

      - name: Deploy to Vercel (dev)
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          npm i -g vercel@latest
          DEPLOYMENT_URL=$(vercel deploy --yes --token "$VERCEL_TOKEN" \
            --build-env SENTRY_AUTH_TOKEN="$SENTRY_AUTH_TOKEN" \
            --build-env SENTRY_ENVIRONMENT="development" \
            --env SENTRY_ENVIRONMENT="development")
          
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          
          # Alias to dev subdomain
          vercel alias "$DEPLOYMENT_URL" dev.tally-tracker.app --token "$VERCEL_TOKEN"

  # ===========================================================================
  # E2E Tests on Development
  # ===========================================================================
  
  e2e-dev:
    name: E2E Tests (dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [deploy-dev-vercel]
    environment: development
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          missing=""
          [ -z "$TEST_USER_EMAIL" ] && missing="$missing TEST_USER_EMAIL"
          [ -z "$TEST_USER_PASSWORD" ] && missing="$missing TEST_USER_PASSWORD"
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "✓ All E2E secrets present"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Wait for deployment
        run: sleep 30

      - name: E2E smoke tests
        run: bun run test:e2e
        env:
          E2E_BASE_URL: https://dev.tally-tracker.app

      - name: E2E auth tests
        run: bun run test:e2e:auth
        env:
          E2E_BASE_URL: https://dev.tally-tracker.app
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-dev
          path: tally-web/playwright-report/

  # ===========================================================================
  # Deploy to Production (only after E2E passes)
  # ===========================================================================
  
  deploy-prod-infra:
    name: Deploy Infra (prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [e2e-dev]
    environment: production
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          PULUMI_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          if [ -z "$PULUMI_TOKEN" ]; then
            echo "::error::Missing required secret: PULUMI_ACCESS_TOKEN"
            exit 1
          fi
          echo "✓ PULUMI_ACCESS_TOKEN present"

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - name: Install deps
        run: npm ci --workspaces=false --include=dev

      - name: Install Pulumi CLI
        run: curl -fsSL https://get.pulumi.com | sh

      - name: Pulumi up (prod)
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          export PATH="$HOME/.pulumi/bin:$PATH"
          pulumi up --yes --stack tally-tracker-org/prod

  deploy-prod-convex:
    name: Deploy Convex (prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [e2e-dev]
    environment: production
    outputs:
      convex_version: ${{ github.sha }}
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Check Convex deploy key
        id: convex_key
        env:
          CONVEX_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_PROD }}
        run: |
          if [ -z "$CONVEX_KEY" ]; then
            echo "::error::Missing required secret: CONVEX_DEPLOY_KEY_PROD"
            exit 1
          fi
          echo "✓ CONVEX_DEPLOY_KEY_PROD present"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Deploy Convex (prod)
        if: steps.convex_key.outputs.skip != 'true'
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_PROD }}
        run: bunx convex deploy --cmd-url-env-var-name CONVEX_DEPLOY_KEY

  deploy-prod-vercel:
    name: Deploy Vercel (prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [deploy-prod-infra, deploy-prod-convex]
    environment: production
    outputs:
      web_version: ${{ github.sha }}
    # Run from repo root; Vercel project Root Directory is already set to "tally-web"
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          missing=""
          [ -z "$VERCEL_TOKEN" ] && missing="$missing VERCEL_TOKEN"
          [ -z "$VERCEL_PROJECT_ID" ] && missing="$missing VERCEL_PROJECT_ID"
          [ -z "$VERCEL_ORG_ID" ] && missing="$missing VERCEL_ORG_ID"
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "✓ All Vercel secrets present"

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write Vercel project.json
        run: |
          mkdir -p .vercel
          cat > .vercel/project.json <<JSON
          {"projectId":"prj_tXdIJDmRB1qKZyo5Ngat62XoaMgw","orgId":"team_ifle7fkp7usKufCL8MUCY1As"}
          JSON

      - name: Deploy to Vercel (prod)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          npm i -g vercel@latest
          vercel deploy --prod --yes --token "$VERCEL_TOKEN" \
            --build-env SENTRY_AUTH_TOKEN="$SENTRY_AUTH_TOKEN" \
            --build-env SENTRY_ENVIRONMENT="production" \
            --env SENTRY_ENVIRONMENT="production"

  # ===========================================================================
  # Post-deployment E2E on Production
  # ===========================================================================
  
  e2e-prod:
    name: E2E Tests (prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [deploy-prod-vercel]
    environment: production
    continue-on-error: true  # Don't fail the pipeline, just report
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          missing=""
          [ -z "$TEST_USER_EMAIL" ] && missing="$missing TEST_USER_EMAIL"
          [ -z "$TEST_USER_PASSWORD" ] && missing="$missing TEST_USER_PASSWORD"
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "✓ All E2E secrets present"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.36"
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Wait for deployment
        run: sleep 30

      - name: E2E smoke tests (prod)
        run: bun run test:e2e
        env:
          E2E_BASE_URL: https://tally-tracker.app

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-prod
          path: tally-web/playwright-report/

  # ===========================================================================
  # Deploy Summary
  # ===========================================================================
  
  deploy-summary:
    name: Deploy Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && always()
    needs: [deploy-prod-convex, deploy-prod-vercel, e2e-prod]
    steps:
      - name: Print deployment summary
        env:
          COMMIT_SHA: ${{ github.sha }}
          CONVEX_VERSION: ${{ needs.deploy-prod-convex.outputs.convex_version }}
          WEB_VERSION: ${{ needs.deploy-prod-vercel.outputs.web_version }}
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${COMMIT_SHA:0:8}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Convex | \`${CONVEX_VERSION:0:8}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Web (Vercel) | \`${WEB_VERSION:0:8}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Full SHA:** \`$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          
          # Verify version alignment
          if [ "$CONVEX_VERSION" != "$WEB_VERSION" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Warning:** Convex and Web versions may be misaligned" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All components deployed from same commit" >> $GITHUB_STEP_SUMMARY
          fi
