# Scheduled Pulumi drift detection
#
# Runs weekly to detect any out-of-band changes to managed resources.
# Alerts if drift is detected so it can be reviewed and reconciled.

name: Infra Drift Detection

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  drift-detection:
    name: Check for infrastructure drift
    runs-on: ubuntu-latest
    strategy:
      matrix:
        stack: [dev, prod]
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Pulumi CLI
        run: curl -fsSL https://get.pulumi.com | sh

      - name: Pulumi refresh (detect drift)
        id: refresh
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          export PATH="$HOME/.pulumi/bin:$PATH"
          
          # Run refresh and capture output
          set +e
          OUTPUT=$(pulumi refresh --stack tally-tracker-org/${{ matrix.stack }} --diff --non-interactive 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          # Check if there's drift (changes detected)
          if echo "$OUTPUT" | grep -q "changes\|update\|replace\|delete\|create"; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "## ⚠️ Drift Detected (${{ matrix.stack }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure state differs from actual resources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" | tail -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "## ✅ No Drift (${{ matrix.stack }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure state matches actual resources." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue if drift detected
        if: steps.refresh.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open drift issue for this stack
          EXISTING=$(gh issue list --label "infra-drift" --label "${{ matrix.stack }}" --state open --json number --jq '.[0].number // empty')
          
          if [ -z "$EXISTING" ]; then
            gh issue create \
              --title "⚠️ Infrastructure drift detected (${{ matrix.stack }} stack)" \
              --body "Pulumi refresh detected drift in the **${{ matrix.stack }}** stack.

This means resources have been modified outside of Pulumi (e.g., manual dashboard changes).

**Action required:**
1. Review the drift in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
2. Either:
   - Run \`pulumi refresh --yes\` to accept the changes into state
   - Run \`pulumi up\` to revert to the desired state
3. Close this issue once resolved

**Stack:** \`tally-tracker-org/${{ matrix.stack }}\`
**Detected:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "infra-drift" \
              --label "${{ matrix.stack }}" \
              --label "automated"
          else
            echo "Drift issue #$EXISTING already exists"
          fi
