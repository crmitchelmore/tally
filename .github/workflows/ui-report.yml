name: UI Report (non-blocking)

on:
  pull_request:

# Allow one concurrent run per PR, cancel previous
concurrency:
  group: ui-report-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Wait for Vercel preview deployment (if available)
  wait-for-preview:
    name: wait for preview
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      preview_url: ${{ steps.preview.outputs.url }}
    steps:
      - name: Wait for Vercel preview
        id: preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        continue-on-error: true
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

  ui-report:
    name: ui report (screenshots)
    runs-on: ubuntu-latest
    needs: wait-for-preview
    continue-on-error: true
    env:
      # Use dev Clerk instance keys for PR screenshot runs
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY_DEV }}
    defaults:
      run:
        working-directory: tally-web
    steps:
      - uses: actions/checkout@v6

      - name: Set E2E base URL (preview)
        if: ${{ needs.wait-for-preview.outputs.preview_url != '' }}
        run: echo "E2E_BASE_URL=${{ needs.wait-for-preview.outputs.preview_url }}" >> $GITHUB_ENV

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.36"

      - name: Install deps
        run: |
          cd ..
          bun install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ms-playwright-${{ runner.os }}-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ms-playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: |
          # Work around intermittent 403s from microsoft apt repos on GH runners
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list || true
          bunx playwright install --with-deps chromium

      - name: Run UI screenshot suite
        id: screenshots
        run: |
          if [ -n "$E2E_BASE_URL" ]; then
            echo "Running against Vercel preview: $E2E_BASE_URL"
            # No webServer needed when testing against preview
            bunx playwright test --grep @ui --reporter=html --update-snapshots --config=playwright.config.ts
          else
            echo "No preview URL; skipping UI screenshots"
            exit 0
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-ui-report
          path: tally-web/playwright-report
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: screenshots
          path: tally-web/tests/e2e/__screenshots__
          retention-days: 14
          if-no-files-found: ignore

      - name: Post screenshot comment
        if: always()
        uses: actions/github-script@v8
        env:
          E2E_BASE_URL: ${{ needs.wait-for-preview.outputs.preview_url }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const screenshotDir = 'tally-web/tests/e2e/__screenshots__/ui-report.spec.ts';
            let screenshots = [];
            
            try {
              if (fs.existsSync(screenshotDir)) {
                screenshots = fs.readdirSync(screenshotDir)
                  .filter(f => f.endsWith('.png'))
                  .map(f => f.replace('.png', ''));
              }
            } catch (e) {
              console.log('Could not read screenshots:', e.message);
            }
            
            const previewUrl = process.env.E2E_BASE_URL || 'localhost:3000';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            let body = `## ðŸ“¸ UI Screenshots\n\n`;
            body += `**Preview URL:** ${previewUrl.startsWith('http') ? previewUrl : 'Local dev server'}\n`;
            body += `**Status:** ${{ steps.screenshots.outcome }}\n\n`;
            
            if (screenshots.length > 0) {
              body += `### Captured Screenshots\n`;
              body += `| Page | Status |\n|------|--------|\n`;
              screenshots.forEach(name => {
                body += `| ${name} | âœ… |\n`;
              });
              body += `\n[View full report](${runUrl}) (download \`playwright-ui-report\` artifact)\n`;
            } else {
              body += `No screenshots captured. [View workflow run](${runUrl})\n`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ðŸ“¸ UI Screenshots')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
