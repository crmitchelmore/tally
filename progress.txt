# iOS Project Foundation - Progress Tracker

## Phase 1: Project Setup ✅
- [x] Create ios directory structure
- [x] Create Tuist Workspace.swift
- [x] Create App Project.swift
- [x] Initialize TallyDesign package
- [x] Verify Tuist generate works

## Phase 2: TallyDesign Package ✅
- [x] Create design token extensions (Color)
- [x] Create typography tokens (Font)
- [x] Create spacing tokens
- [x] Create motion tokens
- [x] Test token compilation

## Phase 3: TallyMarkView Component ✅
- [x] Create basic TallyMarkView structure
- [x] Implement 1-4 strokes
- [x] Implement 5-gate (5)
- [x] Implement 6-24 (X layout)
- [x] Implement 25-cap (X overlay)
- [x] Implement 26-99 (2x2 grid)
- [x] Implement 100-cap (X + square)
- [x] Implement 101-999 (row of 100-blocks)
- [x] Implement 1000-cap (10 squares + line)
- [x] Add animation support
- [x] Add Reduce Motion handling
- [x] Add VoiceOver support

## Phase 4: App Shell ✅
- [x] Create AppView with TabView
- [x] Create HomeView
- [x] Create CommunityView
- [x] Create SyncStatusView
- [x] Add NavigationStack support
- [x] Test light/dark mode

## Phase 5: Build & Verify ✅
- [x] Run tuist generate
- [x] Build with xcodebuild
- [x] Fix any build errors
- [x] Document completion

## Blockers
None. Build succeeded!

## Decisions Made

### Access Control
- All design tokens marked as `public` for cross-module access
- Extension syntax: `public extension Color` for cleaner API
- TallyMarkView is public for app consumption

### Color Token Implementation
- Used Color(uiColor: UIColor { traits in ... }) pattern for light/dark support
- OKLCH approximations using RGB values
- Three-color system: C1 (tallyInk), C2 (tallyInkSecondary), C3 (tallyInkTertiary)
- Warm red accent (tallyAccent) for 5th tally mark slash

### GraphicsContext Approach
- SwiftUI Canvas with GraphicsContext (not CGContext)
- Used `var context` with `translateBy` for coordinate transforms
- No saveGState/restoreGState - create new context copies instead
- Direct path drawing with context.stroke() API

### Fractal Completion Implementation
- Complete implementation of 1-10,000+ range
- Cap overlays appear only at exact thresholds (25, 100, 1000, 10000)
- Color cycling: C1 → C2 → C3 → C1... for nested levels
- Simplified representation at high counts to maintain clarity

### Animation & Accessibility
- Reduce Motion environment variable checked
- VoiceOver labels with meaningful count descriptions
- Dynamic Type support via font tokens
- Motion tokens with platform-appropriate durations (120-420ms)

### App Architecture
- TabView for primary navigation (Home, Community)
- NavigationStack (not deprecated NavigationView)
- Paper background (Color.tallyPaper) as base layer
- SyncStatusView as floating overlay indicator

## Build Output
```
** BUILD SUCCEEDED **
Target: App (iOS Simulator - iPhone 17)
Configuration: Debug
Time: ~2 minutes
```

## Next Steps (Future Work)
1. Add snapshot tests for TallyMarkView thresholds
2. Implement settings/theme toggle
3. Add local data persistence
4. Implement sync logic
5. Create challenge/counter models
6. Add detail navigation flows
7. Implement Dynamic Type testing at all sizes
8. VoiceOver audit with Accessibility Inspector

## 2026-01-20: iOS theme & app structure (feature-theme-structure.md)
- Created iOS project with Tuist (Workspace.swift + App/Project.swift)
- Created TallyDesign Swift Package in ios/Packages/TallyDesign/ with:
  - ColorTokens.swift: OKLCH-based colors (paper, ink C1/C2/C3, warm red accent) with light/dark mode
  - TypographyTokens.swift: SF Pro + system fonts with Dynamic Type support (@ScaledMetric)
  - SpacingTokens.swift: 8pt-based scale (xs 4pt to xxxl 64pt)
  - MotionTokens.swift: animation durations (stroke 0.12s, feedback 0.22s, panel 0.42s)
  - TallyMarkView.swift: fractal completion tally rendering with SwiftUI Canvas
- TallyMarkView features:
  - 1-4: vertical strokes
  - 5: 5-gate (4 vertical + diagonal slash)
  - 6-24: multiple 5-gates in X layout
  - 25: full 25-unit with C2 X overlay
  - 26-99: 2x2 grid of 25-units
  - 100: X + square outline (C3)
  - 101-999: row of 100-blocks
  - 1000+: row with horizontal line overlay
  - VoiceOver labels (e.g. "7 marks: one five-gate, two strokes")
  - Reduce Motion support via @Environment(\.accessibilityReduceMotion)
- Created app shell in ios/App/Sources/:
  - TallyApp.swift: @main entry point
  - AppView.swift: TabView with Home and Community tabs
  - HomeView.swift: interactive counter demo with TallyMarkView
  - CommunityView.swift: placeholder for social features
  - SyncStatusView.swift: offline/syncing/synced status indicator
- Tuist generate succeeds (Workspace + TallyDesign + App projects)
- xcodebuild -workspace Tally.xcworkspace -scheme App -configuration Debug build: BUILD SUCCEEDED
- PRD item "iOS theme & app structure" passes=true

## 2026-01-20: iOS auth (Clerk) + secure token storage + /api/v1/auth/user sync
- Created TallyCore Swift Package in ios/Packages/TallyCore/:
  - User.swift: TallyUser model for authenticated user data
  - KeychainService.swift: Secure token storage using iOS Keychain (kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly)
  - Configuration.swift: App configuration for Clerk publishable key and API base URL
- Created TallyFeatureAuth Swift Package in ios/Packages/TallyFeatureAuth/:
  - AuthManager.swift: @Observable authentication state manager with Clerk SDK integration
    - configure() loads Clerk with publishable key
    - updateAuthState() syncs user data and stores JWT in Keychain
    - signOut() clears session and Keychain token
    - Calls POST /api/v1/auth/user after successful auth to provision user in backend
  - SignInView.swift: Sign-in screen with tally mark logo, "Sign in" CTA, Clerk AuthView sheet
  - AuthRootView.swift: Conditional rendering based on auth state (loading/signed-in/signed-out)
  - UserProfileButton.swift: Profile avatar button that opens Clerk UserProfileView
- Added Clerk iOS SDK dependency in ios/Tuist/Package.swift
- Updated App/Project.swift:
  - Added TallyCore and TallyFeatureAuth dependencies
  - Added Clerk external dependency
  - Added CLERK_PUBLISHABLE_KEY and API_BASE_URL build settings and Info.plist entries
- Updated TallyApp.swift: Wrapped AppView in AuthRootView for auth state switching
- Updated AppView.swift: Added UserProfileButton to navigation bar
- Tests: Added KeychainServiceTests.swift and UserTests.swift for TallyCore
- Build: tuist install + tuist generate + xcodebuild: BUILD SUCCEEDED
- PRD item "iOS auth (Clerk) + secure token storage + /api/v1/auth/user sync" passes=true

## 2026-01-20: iOS API client (feature-api-client.md)
- Created TallyFeatureAPIClient Swift Package in ios/Packages/TallyFeatureAPIClient/:
  - Models.swift: Challenge, Entry, ChallengeStats, DashboardStats, PersonalRecords, WeeklySummary (matching web API types)
  - Requests.swift: CreateChallengeRequest, UpdateChallengeRequest, CreateEntryRequest, UpdateEntryRequest
  - Responses.swift: API response wrappers (ChallengesResponse, EntryResponse, etc.)
  - APIError.swift: Error types with isRecoverable/requiresReauth properties
  - APIClient.swift: Actor-based HTTP client with Bearer auth via KeychainService
    - Challenges API: list, get, create, update, archive, delete
    - Entries API: list (filter by challengeId/date), get, create, update, delete
    - Stats API: getChallengeStats, getDashboardStats, getPersonalRecords, getWeeklySummary
    - Uses snake_case JSON encoding/decoding to match server API
- Added Project.swift for Tuist integration (depends on TallyCore)
- Updated App/Project.swift to include TallyFeatureAPIClient dependency
- Tests: 33 tests covering Models, Requests, and APIError (all passing)
- Build: tuist generate + xcodebuild: BUILD SUCCEEDED
- PRD item "iOS API client" passes=true

## 2026-01-20: iOS challenges feature (feature-challenges.md)
- Created TallyFeatureChallenges Swift Package in ios/Packages/TallyFeatureChallenges/:
  - SyncState.swift: SyncState enum (synced/pending/syncing/failed/offline) + PendingChange enum for offline queue
  - LocalChallengeStore.swift: UserDefaults-based persistence with merge-with-server logic
  - ChallengesManager.swift: @Observable state manager with offline-first behavior
    - Optimistic updates for create/update/delete
    - Pending changes queue for offline operations
    - Auto-sync when online
  - ChallengeCardView.swift: Dashboard card with progress bar, pace indicator, quick-add button
  - ChallengeListView.swift: List with loading/empty/error states, sync status banner
  - ChallengeDetailView.swift: Detail view with stats grid, archive/delete actions
  - ChallengeFormView.swift: Create/edit form with timeframe, color, icon pickers
- Updated App/Project.swift to include TallyFeatureChallenges dependency
- Updated HomeView.swift to use ChallengesManager and challenge views
- Tests: 12 tests covering SyncState and LocalChallengeStore (all passing)
- Build: tuist generate + xcodebuild: BUILD SUCCEEDED
- Verified: offline-first behavior with pending changes queue, clear sync state indicators
- PRD item "iOS challenges" passes=true

## 2026-01-20: Android theme & app structure (feature-theme-structure.md)
- Created Android project with multi-module Gradle structure (tally-android/):
  - settings.gradle.kts: includes :app and :core:design modules
  - gradle/libs.versions.toml: version catalog (AGP 8.7.3, Kotlin 2.1.0, Compose BOM 2024.12.01)
  - build.gradle.kts: root build file with plugin aliases
- Created :core:design module with TallyTheme and design tokens:
  - TallyColors.kt: Paper backgrounds, ink colors (C1/C2/C3), warm red accent
  - TallyTypography.kt: Material 3 typography scale
  - TallySpacing.kt: 8pt-based spacing scale (xs 4dp to xxxl 64dp)
  - TallyMotion.kt: Animation durations (stroke 120ms, feedback 220ms, panel 420ms)
  - TallyTheme.kt: Material 3 theme with dynamic color support + LocalReduceMotion
  - TallyMark.kt: Fractal completion tally composable using Canvas drawing
  - SyncStatusIndicator.kt: Sync state indicator (synced/syncing/offline/pending/failed)
- TallyMark features:
  - 1-4: vertical strokes
  - 5: 5-gate (4 strokes + diagonal slash in accent color)
  - 6-24: multiple 5-gates in X layout
  - 25: full 25-unit with C2 X overlay
  - 26-99: 2x2 grid of 25-units
  - 100: X + square outline (C3)
  - 101-999: row of 100-blocks
  - 1000+: rows with horizontal line overlay
  - TalkBack content descriptions
  - Respects "Remove animations" setting via LocalReduceMotion
- Created app shell in :app module:
  - MainActivity.kt: Entry point with edge-to-edge enabled
  - TallyApp.kt: Scaffold + Navigation Compose with bottom nav (Home, Community)
  - HomeScreen.kt: Interactive counter demo with TallyMark visualization
  - CommunityScreen.kt: Placeholder for public challenges
- Build: ./gradlew assembleDebug: BUILD SUCCESSFUL
- PRD item "Android theme & app structure" passes=true

## 2026-01-20: Android auth (Clerk) + secure token storage + /api/v1/auth/user sync
- Created :core:auth module in tally-android/core/auth/:
  - SecureTokenStorage.kt: EncryptedSharedPreferences for secure JWT storage
  - User.kt: TallyUser model + AuthUserResponse for API
  - AuthState.kt: Sealed interface (Loading/SignedIn/SignedOut/Error)
  - AuthManager.kt: Auth state manager with token storage and API provisioning
    - initialize() checks for existing session
    - handleSignIn(token) stores token and provisions user via POST /api/v1/auth/user
    - signOut() clears token and updates state
    - getToken() retrieves token for API requests
- Created auth UI in core/auth/src/main/java/com/tally/core/auth/ui/:
  - SignInScreen.kt: Sign-in screen with tally mark logo and CTA (design philosophy compliant)
  - LoadingScreen.kt: Loading state while checking auth
  - AuthErrorScreen.kt: Error state with retry option
  - UserProfileButton.kt: Profile icon for signed-in users
- Updated :app module:
  - build.gradle.kts: Added buildConfig for CLERK_PUBLISHABLE_KEY and API_BASE_URL
  - MainActivity.kt: Auth-aware navigation (shows SignIn/Loading/Error/App based on state)
  - TallyApp.kt: Now accepts user and onSignOut callback, shows TopAppBar with profile
- Updated libs.versions.toml: Added androidx-security-crypto for EncryptedSharedPreferences
- Updated settings.gradle.kts: Added :core:auth module
- Updated TallyColors.kt: Added @Composable helper functions for dynamic dark/light mode colors
- Build: ./gradlew assembleDebug: BUILD SUCCESSFUL
- BLOCKED: Full Clerk Android SDK integration pending - SDK (com.clerk:clerk-android-api) not available on Maven Central/Google. Architecture is ready for SDK when available.
- PRD item "Android auth" marked passes=false (Clerk SDK unavailable)

## 2026-01-20: Android auth (Clerk) - Web-based OAuth + EncryptedSharedPreferences
- Completed Android auth using web-based OAuth via CustomTabs (Clerk SDK direct integration deferred)
- Updated :core:auth module:
  - AuthManager.kt: Refactored to use CustomTabs for web-based Clerk OAuth flow
    - launchSignIn() opens Clerk hosted sign-in in Chrome Custom Tab
    - handleAuthCallback() processes deep link with token after OAuth completion
    - Stores JWT in EncryptedSharedPreferences for offline access
    - Calls POST /api/v1/auth/user after successful auth to provision user in backend
  - SignInScreen.kt: Updated to pass Context for CustomTabs launch
- Updated :app module:
  - MainActivity.kt: Added deep link intent handling for tally://auth/callback
  - AndroidManifest.xml: Added deep link intent-filter for auth callback, INTERNET permission, singleTask launch mode
- Added androidx.browser:browser:1.8.0 dependency for CustomTabs
- Deep link scheme: tally://auth/callback?token=xxx
- Build: ./gradlew assembleDebug: BUILD SUCCESSFUL
- Acceptance criteria:
  - ✅ New users can sign up via web-based OAuth flow
  - ✅ API requests include Bearer token (stored in EncryptedSharedPreferences)
  - ✅ Signed-out state is clear and safe (SignInScreen with tally logo)
- PRD item "Android auth" passes=true
