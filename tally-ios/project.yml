name: Tally
options:
  bundleIdPrefix: app.tally
  deploymentTarget:
    iOS: 17.0
packages:
  TallyCore:
    path: TallyCore
  Clerk:
    url: https://github.com/clerk/clerk-ios
    from: 0.57.0
  Sentry:
    url: https://github.com/getsentry/sentry-cocoa
    from: 8.40.0
targets:
  Tally:
    type: application
    platform: iOS
    sources:
      - path: TallyApp
    dependencies:
      - package: TallyCore
      - package: Clerk
      - package: Sentry
        product: Sentry
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.tally.ios
        DEVELOPMENT_TEAM: "$(DEVELOPMENT_TEAM)"
        CODE_SIGN_STYLE: Manual
        CODE_SIGN_IDENTITY: "Apple Distribution"
        PROVISIONING_PROFILE_SPECIFIER: "$(PROVISIONING_PROFILE_SPECIFIER)"
        GENERATE_INFOPLIST_FILE: YES
        INFOPLIST_KEY_CLERK_PUBLISHABLE_KEY: "$(CLERK_PUBLISHABLE_KEY)"
        INFOPLIST_KEY_LAUNCHDARKLY_MOBILE_KEY: "$(LAUNCHDARKLY_MOBILE_KEY)"
        INFOPLIST_KEY_SENTRY_DSN: "$(SENTRY_DSN)"
      configs:
        Debug:
          CLERK_PUBLISHABLE_KEY: "$(CLERK_PUBLISHABLE_KEY_DEV)"
          LAUNCHDARKLY_MOBILE_KEY: "$(LAUNCHDARKLY_MOBILE_KEY_DEV)"
        Release:
          CLERK_PUBLISHABLE_KEY: "$(CLERK_PUBLISHABLE_KEY_PROD)"
          LAUNCHDARKLY_MOBILE_KEY: "$(LAUNCHDARKLY_MOBILE_KEY_PROD)"
    preBuildScripts:
      - name: Upload dSYMs to Sentry
        script: |
          if [ -n "${SENTRY_AUTH_TOKEN}" ]; then
            export SENTRY_ORG="tally-lz"
            export SENTRY_PROJECT="ios"
            sentry-cli upload-dif "${DWARF_DSYM_FOLDER_PATH}" --include-sources || true
          fi
        runOnlyWhenInstalling: false
  TallyTests:
    type: bundle.unit-test
    platform: iOS
    sources:
      - path: TallyAppTests
    dependencies:
      - target: Tally
  TallyUITests:
    type: bundle.ui-testing
    platform: iOS
    sources:
      - path: TallyAppUITests
        optional: true
    dependencies:
      - target: Tally
